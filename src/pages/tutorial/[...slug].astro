---
import { getCollection } from 'astro:content';
import TutorialLayout from '../../layouts/TutorialLayout.astro';
import NavigationButtons from '../../components/NavigationButtons.astro';
import TutorialProgress from '../../components/TutorialProgress.svelte';
import PrerequisiteBox from '../../components/PrerequisiteBox.svelte';
import { extractHeadings } from '../../utils/markdown';

export async function getStaticPaths() {
  const tutorials = await getCollection('tutorials');

  // Define section order (tutorials flow: Host Setup -> Prerequisites -> dstack Installation -> KMS -> Gateway)
  const sectionOrder = ['Host Setup', 'Prerequisites', 'dstack Installation', 'KMS Deployment', 'Gateway Deployment'];

  // Sort tutorials by section, then numbered steps, then appendices
  const sortedTutorials = tutorials.sort((a, b) => {
    // First sort by section using defined order
    if (a.data.section !== b.data.section) {
      const aIndex = sectionOrder.indexOf(a.data.section);
      const bIndex = sectionOrder.indexOf(b.data.section);
      // Unknown sections go to the end
      if (aIndex === -1 && bIndex === -1) return a.data.section.localeCompare(b.data.section);
      if (aIndex === -1) return 1;
      if (bIndex === -1) return -1;
      return aIndex - bIndex;
    }

    // Within same section, appendices come last
    const aIsAppendix = a.data.isAppendix || a.data.stepNumber === null;
    const bIsAppendix = b.data.isAppendix || b.data.stepNumber === null;

    if (aIsAppendix && !bIsAppendix) return 1;
    if (!aIsAppendix && bIsAppendix) return -1;

    // Both are numbered steps or both are appendices
    if (a.data.stepNumber !== null && b.data.stepNumber !== null) {
      return a.data.stepNumber - b.data.stepNumber;
    }

    // Both are appendices, sort by title
    return a.data.title.localeCompare(b.data.title);
  });

  return sortedTutorials.map((tutorial, index) => {
    const previousTutorial = index > 0 ? sortedTutorials[index - 1] : null;
    const nextTutorial = index < sortedTutorials.length - 1 ? sortedTutorials[index + 1] : null;

    return {
      params: { slug: tutorial.slug },
      props: {
        tutorial,
        previousTutorial,
        nextTutorial,
        allTutorials: sortedTutorials,
      },
    };
  });
}

const { tutorial, previousTutorial, nextTutorial, allTutorials } = Astro.props;
const { Content } = await tutorial.render();
const { title, description, section, stepNumber, totalSteps, prerequisites } = tutorial.data;

// Extract headings from tutorial markdown content for table of contents
const headings = extractHeadings(tutorial.body);
---

<TutorialLayout
  title={title}
  description={description}
  section={section}
  totalSteps={totalSteps}
  currentStep={stepNumber}
  allTutorials={allTutorials}
  currentSlug={tutorial.slug}
  headings={headings}
>
  {prerequisites && prerequisites.length > 0 && (
    <PrerequisiteBox
      client:load
      prerequisites={prerequisites}
      allTutorials={allTutorials.map(t => ({
        slug: t.slug,
        title: t.data.title,
        description: t.data.description,
        estimatedTime: t.data.estimatedTime,
        prerequisites: t.data.prerequisites,
        isAppendix: t.data.isAppendix || t.data.stepNumber === null
      }))}
    />
  )}

  <Content />

  <!-- Tutorial Progress Tracker -->
  <div class="mt-8">
    <TutorialProgress client:load tutorialSlug={tutorial.slug} />
  </div>

  <!-- Navigation Buttons -->
  <div class="mt-8 pt-8 border-t border-border-default">
    <NavigationButtons
      previousUrl={previousTutorial ? `/tutorial/${previousTutorial.slug}` : undefined}
      previousLabel={previousTutorial ? previousTutorial.data.title : undefined}
      nextUrl={nextTutorial ? `/tutorial/${nextTutorial.slug}` : '/tutorial/complete'}
      nextLabel={nextTutorial ? nextTutorial.data.title : 'View Progress'}
    />
  </div>
</TutorialLayout>

---
# setup-guest-images.yml
# Phase 5.1: Set up guest OS images and teepod service
#
# Prerequisites:
#   - Gateway service running (Phase 4)
#   - dstack repository cloned (Phase 2.3)
#
# Variables (set in group_vars/all.yml or via -e):
#   - dstack_version: Guest OS image version (default: 0.4.0)
#   - teepod_http_port: HTTP API port (default: 9080)
#
# Usage:
#   ansible-playbook -i inventory/hosts.yml playbooks/setup-guest-images.yml

- name: Set up Guest OS Images and Teepod
  hosts: dstack_servers
  become: yes
  vars:
    dstack_repo_path: /root/dstack
    images_dir: /var/lib/dstack/images
    run_dir: /var/lib/dstack/run
    teepod_config_dir: /etc/dstack/teepod
    dstack_version: "0.4.0"
    teepod_http_port: 9080
    cid_start: 30000
    cid_pool_size: 1000

  tasks:
    - name: Create image directory structure
      ansible.builtin.file:
        path: "{{ images_dir }}"
        state: directory
        mode: '0755'
        owner: root
        group: root

    - name: Create runtime directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
        owner: root
        group: root
      loop:
        - "{{ run_dir }}"
        - /var/run/teepod

    - name: Check if image already exists
      ansible.builtin.stat:
        path: "{{ images_dir }}/dstack-{{ dstack_version }}/metadata.json"
      register: image_exists

    - name: Download guest OS image
      ansible.builtin.get_url:
        url: "https://github.com/Dstack-TEE/meta-dstack/releases/download/v{{ dstack_version }}/dstack-{{ dstack_version }}.tar.gz"
        dest: "/tmp/dstack-{{ dstack_version }}.tar.gz"
        mode: '0644'
      when: not image_exists.stat.exists

    - name: Create image version directory
      ansible.builtin.file:
        path: "{{ images_dir }}/dstack-{{ dstack_version }}"
        state: directory
        mode: '0755'
        owner: root
        group: root
      when: not image_exists.stat.exists

    - name: Extract guest OS image
      ansible.builtin.unarchive:
        src: "/tmp/dstack-{{ dstack_version }}.tar.gz"
        dest: "{{ images_dir }}/dstack-{{ dstack_version }}/"
        remote_src: yes
      when: not image_exists.stat.exists

    - name: Verify image components exist
      ansible.builtin.stat:
        path: "{{ images_dir }}/dstack-{{ dstack_version }}/{{ item }}"
      loop:
        - OVMF.fd
        - bzImage
        - initramfs.cpio.gz
        - rootfs.cpio
        - metadata.json
      register: image_components

    - name: Fail if image components missing
      ansible.builtin.fail:
        msg: "Image component {{ item.item }} is missing"
      when: not item.stat.exists
      loop: "{{ image_components.results }}"
      loop_control:
        label: "{{ item.item }}"

    - name: Display image metadata
      ansible.builtin.command:
        cmd: cat {{ images_dir }}/dstack-{{ dstack_version }}/metadata.json
      register: metadata
      changed_when: false

    - name: Show image version
      ansible.builtin.debug:
        msg: "Image version: {{ (metadata.stdout | from_json).version }}"

    - name: Check dstack repository exists
      ansible.builtin.stat:
        path: "{{ dstack_repo_path }}/Cargo.toml"
      register: dstack_repo

    - name: Fail if dstack repository not found
      ansible.builtin.fail:
        msg: "dstack repository not found at {{ dstack_repo_path }}. Run Phase 2.3 first."
      when: not dstack_repo.stat.exists

    - name: Build teepod
      ansible.builtin.shell:
        cmd: |
          source $HOME/.cargo/env
          cargo build --release -p teepod
        chdir: "{{ dstack_repo_path }}"
        executable: /bin/bash
      register: teepod_build
      changed_when: "'Compiling' in teepod_build.stderr"

    - name: Install teepod binary
      ansible.builtin.copy:
        src: "{{ dstack_repo_path }}/target/release/teepod"
        dest: /usr/local/bin/teepod
        remote_src: yes
        mode: '0755'
        owner: root
        group: root

    - name: Verify teepod installation
      ansible.builtin.command:
        cmd: /usr/local/bin/teepod --version
      register: teepod_version
      changed_when: false
      failed_when: false

    - name: Display teepod version
      ansible.builtin.debug:
        msg: "Teepod version: {{ teepod_version.stdout | default('unable to determine') }}"

    - name: Create teepod configuration directory
      ansible.builtin.file:
        path: "{{ teepod_config_dir }}"
        state: directory
        mode: '0755'
        owner: root
        group: root

    - name: Create teepod configuration file
      ansible.builtin.copy:
        content: |
          # Teepod Configuration
          # Generated by Ansible

          # API server configuration
          address = "unix:/var/run/teepod.sock"
          http_address = "127.0.0.1:{{ teepod_http_port }}"

          # Image and runtime paths
          image_path = "{{ images_dir }}"
          run_path = "{{ run_dir }}"

          # CVM configuration
          [cvm]
          # KMS endpoints for key management
          kms_urls = ["http://127.0.0.1:9100"]

          # Gateway/tproxy endpoints for network access
          tproxy_urls = ["http://127.0.0.1:9070"]

          # VSOCK CID pool for CVMs
          cid_start = {{ cid_start }}
          cid_pool_size = {{ cid_pool_size }}

          # Port mapping for CVM network access
          [cvm.port_mapping]
          enabled = true
          address = "127.0.0.1"
          range = [
              { protocol = "tcp", from = 1, to = 20000 },
              { protocol = "udp", from = 1, to = 20000 },
          ]

          # Default CVM resources
          [cvm.defaults]
          vcpus = 2
          memory = 2048
          disk_size = 10240
        dest: "{{ teepod_config_dir }}/teepod.toml"
        mode: '0644'
        owner: root
        group: root
      notify: Restart teepod

    - name: Create teepod systemd service
      ansible.builtin.copy:
        content: |
          [Unit]
          Description=dstack Teepod CVM Manager
          Documentation=https://dstack.info
          After=network.target dstack-kms.service dstack-gateway.service
          Wants=dstack-kms.service dstack-gateway.service

          [Service]
          Type=simple
          User=root
          ExecStart=/usr/local/bin/teepod --config {{ teepod_config_dir }}/teepod.toml
          Restart=always
          RestartSec=5
          StandardOutput=journal
          StandardError=journal

          WorkingDirectory=/var/lib/dstack

          Environment="RUST_LOG=info"

          NoNewPrivileges=false
          ProtectSystem=strict
          ReadWritePaths=/var/lib/dstack /var/run/teepod /tmp

          LimitNOFILE=65535
          LimitNPROC=65535

          [Install]
          WantedBy=multi-user.target
        dest: /etc/systemd/system/dstack-teepod.service
        mode: '0644'
        owner: root
        group: root
      notify: Reload systemd

    - name: Flush handlers
      ansible.builtin.meta: flush_handlers

    - name: Enable teepod service
      ansible.builtin.systemd:
        name: dstack-teepod
        enabled: yes
        daemon_reload: yes

    - name: Start teepod service
      ansible.builtin.systemd:
        name: dstack-teepod
        state: started

    - name: Wait for teepod to start
      ansible.builtin.pause:
        seconds: 3

    - name: Check teepod service status
      ansible.builtin.command:
        cmd: systemctl is-active dstack-teepod
      register: teepod_status
      changed_when: false
      failed_when: false

    - name: Test teepod HTTP API
      ansible.builtin.uri:
        url: "http://127.0.0.1:{{ teepod_http_port }}/api/images"
        method: GET
        return_content: yes
      register: api_response
      retries: 5
      delay: 2
      until: api_response.status == 200
      failed_when: false

    - name: Display available images
      ansible.builtin.debug:
        msg: "Available images: {{ api_response.json.images | default([]) | map(attribute='name') | list }}"
      when: api_response.status == 200

    - name: Get teepod logs (last 20 lines)
      ansible.builtin.command:
        cmd: journalctl -u dstack-teepod -n 20 --no-pager
      register: teepod_logs
      changed_when: false
      failed_when: false

    - name: Summary
      ansible.builtin.debug:
        msg:
          - "Guest image setup complete!"
          - "Image: dstack-{{ dstack_version }}"
          - "Image path: {{ images_dir }}/dstack-{{ dstack_version }}"
          - "Teepod status: {{ teepod_status.stdout }}"
          - "HTTP API: http://127.0.0.1:{{ teepod_http_port }}"
          - ""
          - "Commands:"
          - "  Status:  sudo systemctl status dstack-teepod"
          - "  Logs:    sudo journalctl -u dstack-teepod -f"
          - "  Images:  curl http://127.0.0.1:{{ teepod_http_port }}/api/images"

  handlers:
    - name: Reload systemd
      ansible.builtin.systemd:
        daemon_reload: yes

    - name: Restart teepod
      ansible.builtin.systemd:
        name: dstack-teepod
        state: restarted

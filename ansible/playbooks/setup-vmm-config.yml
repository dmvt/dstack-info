---
# Ansible playbook to setup VMM configuration
# Usage: ansible-playbook -i inventory/hosts.yml playbooks/setup-vmm-config.yml
#
# Configurable variables (pass with -e):
#   vmm_workers        - Number of worker threads (default: 8)
#   vmm_log_level      - Log level: debug, info, warn, error (default: info)
#   cvm_max_vcpu       - Max vCPUs per CVM (default: 16)
#   cvm_max_memory_mb  - Max memory per CVM in MB (default: 65536)
#   vmm_kms_url        - KMS service URL (default: http://127.0.0.1:8081)
#   cvm_cid_start      - Starting CID for CVMs (default: 1000)
#   cvm_cid_pool_size  - Number of CIDs in pool (default: 1000)
#
# Examples:
#   # Basic setup with defaults
#   ansible-playbook -i inventory/hosts.yml playbooks/setup-vmm-config.yml
#
#   # Custom resource limits
#   ansible-playbook -i inventory/hosts.yml playbooks/setup-vmm-config.yml \
#     -e "cvm_max_vcpu=32" -e "cvm_max_memory_mb=131072"
#
#   # Enable debug logging
#   ansible-playbook -i inventory/hosts.yml playbooks/setup-vmm-config.yml \
#     -e "vmm_log_level=debug"
#
# This playbook:
# - Creates /etc/dstack directory
# - Creates vmm.toml configuration file
# - Creates runtime directories
# - Sets appropriate permissions

- name: Setup VMM Configuration
  hosts: dstack_servers
  become: true
  vars:
    # Directory paths (generally don't need to change)
    dstack_config_dir: "/etc/dstack"
    dstack_run_dir: "/var/run/dstack"
    dstack_log_dir: "/var/log/dstack"
    dstack_lib_dir: "/var/lib/dstack"

    # VMM Configuration defaults - override with -e flags
    vmm_workers: 8
    vmm_max_blocking: 64
    vmm_log_level: "info"
    vmm_address: "unix:/var/run/dstack/vmm.sock"
    vmm_kms_url: "http://127.0.0.1:8081"

    # CVM Configuration defaults - override with -e flags
    cvm_max_vcpu: 16
    cvm_max_memory_mb: 65536
    cvm_cid_start: 1000
    cvm_cid_pool_size: 1000

  tasks:
    - name: Create dstack config directory
      ansible.builtin.file:
        path: "{{ dstack_config_dir }}"
        state: directory
        mode: '0755'

    - name: Create runtime directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - "{{ dstack_run_dir }}"
        - "{{ dstack_log_dir }}"
        - "{{ dstack_lib_dir }}"

    - name: Create VMM configuration file
      ansible.builtin.copy:
        dest: "{{ dstack_config_dir }}/vmm.toml"
        mode: '0644'
        content: |
          # dstack VMM Configuration
          # Generated by Ansible
          # See: https://dstack.info/tutorial/vmm-configuration

          # Server settings
          workers = {{ vmm_workers }}
          max_blocking = {{ vmm_max_blocking }}
          ident = "dstack VMM"
          temp_dir = "/tmp"
          keep_alive = 10
          log_level = "{{ vmm_log_level }}"
          address = "{{ vmm_address }}"
          reuse = true
          kms_url = "{{ vmm_kms_url }}"
          event_buffer_size = 20
          node_name = ""

          [cvm]
          qemu_path = ""
          kms_urls = ["{{ vmm_kms_url }}"]
          gateway_urls = ["http://127.0.0.1:8082"]
          pccs_url = ""
          docker_registry = ""
          cid_start = {{ cvm_cid_start }}
          cid_pool_size = {{ cvm_cid_pool_size }}
          max_allocable_vcpu = {{ cvm_max_vcpu }}
          max_allocable_memory_in_mb = {{ cvm_max_memory_mb }}
          qmp_socket = false
          user = ""
          use_mrconfigid = true
          qemu_pci_hole64_size = 0
          qemu_hotplug_off = false

          [cvm.networking]
          mode = "user"
          net = "10.0.2.0/24"
          dhcp_start = "10.0.2.10"
          restrict = false

          [cvm.port_mapping]
          enabled = false
          address = "127.0.0.1"
          range = [
              { protocol = "tcp", from = 1, to = 20000 },
          ]

          [cvm.auto_restart]
          enabled = true
          interval = 20

          [cvm.gpu]
          enabled = false
          listing = []
          exclude = []
          include = []
          allow_attach_all = false

          [gateway]
          base_domain = "localhost"
          port = 8082
          agent_port = 8090

          [auth]
          enabled = false
          tokens = []

          [supervisor]
          exe = "/usr/local/bin/dstack-supervisor"
          sock = "{{ dstack_run_dir }}/supervisor.sock"
          pid_file = "{{ dstack_run_dir }}/supervisor.pid"
          log_file = "{{ dstack_log_dir }}/supervisor.log"
          detached = false
          auto_start = true

          [host_api]
          ident = "dstack VMM"
          address = "vsock:2"
          port = 10000

          [key_provider]
          enabled = true
          address = "127.0.0.1"
          port = 3443

    - name: Display configuration summary
      ansible.builtin.debug:
        msg:
          - "VMM configuration created successfully!"
          - ""
          - "Configuration file: {{ dstack_config_dir }}/vmm.toml"
          - "Runtime directory: {{ dstack_run_dir }}"
          - "Log directory: {{ dstack_log_dir }}"
          - "Data directory: {{ dstack_lib_dir }}"
          - ""
          - "Resource limits:"
          - "  - Max vCPUs: {{ cvm_max_vcpu }}"
          - "  - Max Memory: {{ cvm_max_memory_mb }}MB"

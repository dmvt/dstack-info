---
# Verify PCCS Configuration for TDX Attestation
#
# Usage:
#   ansible-playbook -i inventory/hosts.yml playbooks/verify-pccs-config.yml
#
# This playbook verifies the attestation infrastructure is ready BEFORE CVM deployment:
#   - PCCS service is running
#   - Intel API key is configured
#   - QGSD service is running
#   - PCCS can respond to requests
#
# Note: This is different from verify-attestation.yml which verifies running CVMs.

- name: Verify PCCS Configuration for TDX Attestation
  hosts: tdx-host
  become: true
  vars:
    pccs_config_path: /opt/intel/sgx-dcap-pccs/config/default.json

  tasks:
    - name: Check PCCS service status
      ansible.builtin.systemd:
        name: pccs
      register: pccs_status

    - name: Fail if PCCS not running
      ansible.builtin.fail:
        msg: |
          PCCS service is not running.

          Start it with: sudo systemctl start pccs
          Check logs with: sudo journalctl -u pccs -n 50
      when: pccs_status.status.ActiveState != "active"

    - name: Check PCCS API key is configured
      ansible.builtin.shell: |
        grep '"ApiKey"' {{ pccs_config_path }} | grep -v '""'
      register: api_key_check
      ignore_errors: true
      changed_when: false

    - name: Fail if API key not configured
      ansible.builtin.fail:
        msg: |
          PCCS is not configured with an Intel API key.

          TDX attestation is REQUIRED for CVM deployment.

          Please complete the attestation setup:
            ansible-playbook -i inventory/hosts.yml playbooks/configure-pccs.yml

          Or follow the manual tutorial:
            https://dstack.info/tutorial/tdx-attestation-setup
      when: api_key_check.rc != 0

    - name: Check QGSD service status
      ansible.builtin.systemd:
        name: qgsd
      register: qgsd_status

    - name: Fail if QGSD not running
      ansible.builtin.fail:
        msg: |
          QGSD (Quote Generation Service) is not running.

          Start it with: sudo systemctl start qgsd
          Check logs with: sudo journalctl -u qgsd -n 50
      when: qgsd_status.status.ActiveState != "active"

    - name: Test PCCS health endpoint
      ansible.builtin.uri:
        url: http://127.0.0.1:8081/sgx/certification/v4/rootcacrl
        return_content: false
        status_code: [200, 404]  # 404 is OK if no cached certs yet
        timeout: 10
      register: pccs_health
      ignore_errors: true

    - name: Warn if PCCS not responding
      ansible.builtin.debug:
        msg: |
          WARNING: PCCS health endpoint not responding.
          This may be normal if no certificates have been cached yet.
          The first CVM deployment will trigger certificate fetching.
      when: pccs_health.failed | default(false)

    - name: Check for recent PCCS errors
      ansible.builtin.shell: |
        journalctl -u pccs --since "5 minutes ago" --no-pager 2>/dev/null | grep -i "error\|401\|fail" | tail -5 || true
      register: pccs_errors
      changed_when: false

    - name: Display PCCS errors if any
      ansible.builtin.debug:
        msg: |
          Recent PCCS errors detected:
          {{ pccs_errors.stdout }}

          Check full logs with: sudo journalctl -u pccs -n 100
      when: pccs_errors.stdout != ""

    - name: Check for recent QGSD errors
      ansible.builtin.shell: |
        journalctl -u qgsd --since "5 minutes ago" --no-pager 2>/dev/null | grep -i "error\|fail" | tail -5 || true
      register: qgsd_errors
      changed_when: false

    - name: Display QGSD errors if any
      ansible.builtin.debug:
        msg: |
          Recent QGSD errors detected:
          {{ qgsd_errors.stdout }}

          Check full logs with: sudo journalctl -u qgsd -n 100
      when: qgsd_errors.stdout != ""

    - name: PCCS configuration verification summary
      ansible.builtin.debug:
        msg: |
          ========================================
          PCCS Configuration Verification Summary
          ========================================

          PCCS Service:     {{ 'Running' if pccs_status.status.ActiveState == 'active' else 'NOT RUNNING' }}
          API Key:          {{ 'Configured' if api_key_check.rc == 0 else 'NOT CONFIGURED' }}
          QGSD Service:     {{ 'Running' if qgsd_status.status.ActiveState == 'active' else 'NOT RUNNING' }}
          PCCS Health:      {{ 'OK' if not (pccs_health.failed | default(false)) else 'Check logs' }}

          {% if pccs_errors.stdout == "" and qgsd_errors.stdout == "" %}
          Status: READY for CVM deployment
          {% else %}
          Status: CHECK LOGS - errors detected
          {% endif %}

          ========================================

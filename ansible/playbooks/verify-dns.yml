---
- name: Verify DNS Configuration for dstack
  hosts: localhost
  gather_facts: no

  vars_files:
    - ../vars/quick-start.yml

  vars:
    # Server IP from inventory or override
    server_ip: "{{ hostvars[groups['dstack_servers'][0]]['ansible_host'] | default('') }}"
    # Test subdomains for wildcard verification
    test_subdomains:
      - "test"
      - "app"
      - "example"

  tasks:
    - name: Check required variables are defined
      assert:
        that:
          - base_domain is defined
          - base_domain != ""
          - server_ip is defined
          - server_ip != ""
        fail_msg: |
          Required variables not defined.

          Ensure vars/quick-start.yml contains:
            base_domain: "yourdomain.com"

          And inventory/hosts.yml contains:
            ansible_host: YOUR_SERVER_IP

        success_msg: "✓ All required variables defined (base_domain: {{ base_domain }}, server_ip: {{ server_ip }})"

    - name: Test DNS resolution for base domain
      shell: |
        dig +short {{ base_domain }} A | head -1
      register: base_dns_result
      failed_when: false
      changed_when: false

    - name: Verify base domain resolves to correct IP
      assert:
        that:
          - base_dns_result.stdout == server_ip
        fail_msg: |
          ✗ DNS resolution failed for {{ base_domain }}
          Expected IP: {{ server_ip }}
          Got: {{ base_dns_result.stdout | default('No response') }}

          Troubleshooting:
          1. Check A record exists: {{ base_domain }} → {{ server_ip }}
          2. Verify nameservers are configured correctly
          3. Wait for DNS propagation (can take up to 48 hours)
          4. Test directly against Cloudflare DNS: dig @1.1.1.1 {{ base_domain }}

          See tutorial: https://dstack.info/tutorial/dns-configuration
        success_msg: "✓ Base domain {{ base_domain }} resolves to {{ server_ip }}"

    - name: Test wildcard DNS resolution
      shell: |
        dig +short {{ item }}.{{ base_domain }} A | head -1
      loop: "{{ test_subdomains }}"
      register: wildcard_dns_results
      failed_when: false
      changed_when: false

    - name: Verify wildcard DNS resolves correctly
      assert:
        that:
          - item.stdout == server_ip
        fail_msg: |
          ✗ Wildcard DNS resolution failed for {{ item.item }}.{{ base_domain }}
          Expected IP: {{ server_ip }}
          Got: {{ item.stdout | default('No response') }}

          Troubleshooting:
          1. Check wildcard A record exists: *.{{ base_domain }} → {{ server_ip }}
          2. Verify proxy status is "DNS only" (gray cloud) in Cloudflare
          3. Wait for DNS propagation
          4. Test with: dig {{ item.item }}.{{ base_domain }}

          See tutorial: https://dstack.info/tutorial/dns-configuration#step-2-configure-dns-records
        success_msg: "✓ Wildcard subdomain {{ item.item }}.{{ base_domain }} resolves to {{ server_ip }}"
      loop: "{{ wildcard_dns_results.results }}"

    - name: Test DNS resolution from multiple resolvers
      shell: |
        dig @{{ item.resolver }} +short {{ base_domain }} A | head -1
      loop:
        - { name: "Cloudflare DNS", resolver: "1.1.1.1" }
        - { name: "Google DNS", resolver: "8.8.8.8" }
      register: resolver_results
      failed_when: false
      changed_when: false

    - name: Verify consistent DNS resolution across resolvers
      assert:
        that:
          - item.stdout == server_ip
        fail_msg: |
          ✗ Inconsistent DNS resolution from {{ item.item.name }}
          Expected IP: {{ server_ip }}
          Got: {{ item.stdout | default('No response') }}

          This may indicate:
          1. DNS propagation still in progress
          2. Stale DNS cache at resolver
          3. Incorrect DNS configuration

          Wait a few minutes and try again. DNS propagation can take time.
        success_msg: "✓ {{ item.item.name }} resolves {{ base_domain }} to {{ server_ip }}"
      loop: "{{ resolver_results.results }}"

    - name: Check CAA records on base domain
      shell: |
        dig +short {{ base_domain }} CAA
      register: caa_base_result
      failed_when: false
      changed_when: false

    - name: Extract parent domain for CAA check
      set_fact:
        parent_domain: "{{ base_domain.split('.')[1:] | join('.') }}"

    - name: Check CAA records on parent domain
      shell: |
        dig +short {{ parent_domain }} CAA
      register: caa_parent_result
      failed_when: false
      changed_when: false

    - name: Report CAA record status (base domain)
      debug:
        msg:
          - "✓ CAA records configured on {{ base_domain }}:"
          - "{{ caa_base_result.stdout }}"
      when: caa_base_result.stdout | length > 0

    - name: Report CAA record status (parent domain)
      debug:
        msg:
          - "✓ CAA records configured on parent domain {{ parent_domain }} (inherited by subdomains):"
          - "{{ caa_parent_result.stdout }}"
      when:
        - caa_base_result.stdout | length == 0
        - caa_parent_result.stdout | length > 0

    - name: Report CAA record status (none found)
      debug:
        msg:
          - "⚠ No CAA records found (optional but recommended)"
          - ""
          - "CAA records restrict certificate issuance to specific authorities."
          - "While optional, they improve security."
          - ""
          - "To add CAA records, see:"
          - "  https://dstack.info/tutorial/dns-configuration#step-2-configure-dns-records"
      when:
        - caa_base_result.stdout | length == 0
        - caa_parent_result.stdout | length == 0

    - name: DNS verification summary
      debug:
        msg:
          - "═══════════════════════════════════════════════════════════════"
          - "DNS Verification Complete ✅"
          - "═══════════════════════════════════════════════════════════════"
          - ""
          - "Domain Configuration:"
          - "  • Base domain: {{ base_domain }} → {{ server_ip }}"
          - "  • Wildcard: *.{{ base_domain }} → {{ server_ip }}"
          - "  • Tested subdomains: {{ test_subdomains | join(', ') }}"
          - "  • All resolvers consistent: ✓"
          - "═══════════════════════════════════════════════════════════════"

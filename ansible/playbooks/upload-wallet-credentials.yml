---
# Ansible playbook to upload wallet credentials to the server
# Usage: ansible-playbook -i inventory/hosts.yml playbooks/upload-wallet-credentials.yml
#
# Prerequisites:
#   Local wallet credentials from Blockchain Setup tutorial:
#   - ~/.dstack/secrets/sepolia-address      - Ethereum wallet address
#   - ~/.dstack/secrets/sepolia-private-key  - Ethereum wallet private key
#
# This playbook:
# - Checks if credentials already exist on server (skips upload if they do)
# - Creates secure secrets directory on server
# - Uploads wallet credentials from local machine
# - Sets appropriate file permissions

- name: Upload Wallet Credentials to Server
  hosts: dstack_servers
  become: false
  vars:
    local_secrets_dir: "{{ lookup('env', 'HOME') }}/.dstack/secrets"
    remote_secrets_dir: "/home/{{ ansible_user }}/.dstack/secrets"

  tasks:
    - name: Check if local secrets directory exists
      ansible.builtin.stat:
        path: "{{ local_secrets_dir }}"
      delegate_to: localhost
      register: local_secrets_check

    - name: Fail if local secrets not found
      ansible.builtin.fail:
        msg: |
          Local secrets directory not found at {{ local_secrets_dir }}

          Complete the Blockchain Setup tutorial first:
            https://dstack.info/tutorial/blockchain-setup
      when: not local_secrets_check.stat.exists

    - name: Check if local private key exists
      ansible.builtin.stat:
        path: "{{ local_secrets_dir }}/sepolia-private-key"
      delegate_to: localhost
      register: local_private_key_check

    - name: Fail if local private key not found
      ansible.builtin.fail:
        msg: |
          Local private key not found at {{ local_secrets_dir }}/sepolia-private-key

          Complete the Blockchain Setup tutorial first:
            https://dstack.info/tutorial/blockchain-setup
      when: not local_private_key_check.stat.exists

    - name: Check if local address exists
      ansible.builtin.stat:
        path: "{{ local_secrets_dir }}/sepolia-address"
      delegate_to: localhost
      register: local_address_check

    - name: Fail if local address not found
      ansible.builtin.fail:
        msg: |
          Local address not found at {{ local_secrets_dir }}/sepolia-address

          Complete the Blockchain Setup tutorial first:
            https://dstack.info/tutorial/blockchain-setup
      when: not local_address_check.stat.exists

    - name: Check if remote secrets directory exists
      ansible.builtin.stat:
        path: "{{ remote_secrets_dir }}"
      register: remote_secrets_check

    - name: Check if remote private key already exists
      ansible.builtin.stat:
        path: "{{ remote_secrets_dir }}/sepolia-private-key"
      register: remote_private_key_check
      when: remote_secrets_check.stat.exists

    - name: Check if remote address already exists
      ansible.builtin.stat:
        path: "{{ remote_secrets_dir }}/sepolia-address"
      register: remote_address_check
      when: remote_secrets_check.stat.exists

    - name: Display status - credentials already exist
      ansible.builtin.debug:
        msg:
          - "============================================"
          - "Wallet credentials already exist on server!"
          - "============================================"
          - ""
          - "Location: {{ remote_secrets_dir }}"
          - "  - sepolia-address: EXISTS"
          - "  - sepolia-private-key: EXISTS"
          - ""
          - "Skipping upload to preserve existing credentials."
          - "Delete remote files if you want to replace them."
      when:
        - remote_secrets_check.stat.exists
        - remote_private_key_check.stat.exists | default(false)
        - remote_address_check.stat.exists | default(false)

    - name: Create remote secrets directory
      ansible.builtin.file:
        path: "{{ remote_secrets_dir }}"
        state: directory
        mode: '0700'
      when: not remote_secrets_check.stat.exists

    - name: Create parent .dstack directory if needed
      ansible.builtin.file:
        path: "/home/{{ ansible_user }}/.dstack"
        state: directory
        mode: '0755'
      when: not remote_secrets_check.stat.exists

    - name: Upload wallet address
      ansible.builtin.copy:
        src: "{{ local_secrets_dir }}/sepolia-address"
        dest: "{{ remote_secrets_dir }}/sepolia-address"
        mode: '0600'
      when: not (remote_address_check.stat.exists | default(false))
      register: address_uploaded

    - name: Upload wallet private key
      ansible.builtin.copy:
        src: "{{ local_secrets_dir }}/sepolia-private-key"
        dest: "{{ remote_secrets_dir }}/sepolia-private-key"
        mode: '0600'
      when: not (remote_private_key_check.stat.exists | default(false))
      no_log: true
      register: private_key_uploaded

    - name: Read uploaded address for display
      ansible.builtin.slurp:
        src: "{{ remote_secrets_dir }}/sepolia-address"
      register: wallet_address_content
      when: address_uploaded.changed | default(false) or private_key_uploaded.changed | default(false)

    - name: Display upload summary
      ansible.builtin.debug:
        msg:
          - "============================================"
          - "Wallet Credentials Uploaded Successfully!"
          - "============================================"
          - ""
          - "Wallet address: {{ wallet_address_content.content | b64decode | trim }}"
          - "Location: {{ remote_secrets_dir }}"
          - ""
          - "Files uploaded:"
          - "  - sepolia-address (mode 0600)"
          - "  - sepolia-private-key (mode 0600)"
          - ""
          - "You can now run the contract deployment playbook."
      when: address_uploaded.changed | default(false) or private_key_uploaded.changed | default(false)

---
# Configure PCCS with Intel API Key for TDX Attestation
#
# Usage (via quick-start.yml - recommended):
#   Configure intel_pccs_api_key in vars/quick-start.yml
#   ansible-playbook -i inventory/hosts.yml playbooks/configure-pccs.yml
#
# Usage (via environment variable):
#   export INTEL_API_KEY="your-api-key-here"
#   ansible-playbook -i inventory/hosts.yml playbooks/configure-pccs.yml
#
# Prerequisites:
#   - PCCS installed (from tdx-software-installation)
#   - Intel API key from https://api.portal.trustedservices.intel.com/

- name: Configure PCCS with Intel API Key
  hosts: tdx-host
  become: true

  vars_files:
    - ../vars/quick-start.yml

  vars:
    # Use intel_pccs_api_key from quick-start.yml, fall back to environment variable
    intel_api_key: "{{ intel_pccs_api_key | default(lookup('env', 'INTEL_API_KEY'), true) | default('', true) }}"
    pccs_config_path: /opt/intel/sgx-dcap-pccs/config/default.json

  tasks:
    - name: Validate Intel API key is provided
      ansible.builtin.fail:
        msg: |
          Intel API key is required.

          Please configure in vars/quick-start.yml:
            intel_pccs_api_key: "your-key"

          Or set environment variable:
            export INTEL_API_KEY="your-key"

          To get an API key:
            1. Go to https://api.portal.trustedservices.intel.com/
            2. Sign in or create an account
            3. Subscribe to "Intel SGX and Intel TDX Provisioning Certification Service"
            4. Copy your Primary or Secondary key from your Profile
      when: intel_api_key == ""

    - name: Check PCCS is installed
      ansible.builtin.stat:
        path: "{{ pccs_config_path }}"
      register: pccs_config_stat

    - name: Fail if PCCS not installed
      ansible.builtin.fail:
        msg: |
          PCCS configuration not found at {{ pccs_config_path }}

          Please complete the TDX Software Installation tutorial first:
            https://dstack.info/tutorial/tdx-software-installation
      when: not pccs_config_stat.stat.exists

    - name: Read current PCCS configuration
      ansible.builtin.slurp:
        src: "{{ pccs_config_path }}"
      register: pccs_config_content

    - name: Parse current configuration
      ansible.builtin.set_fact:
        pccs_config: "{{ pccs_config_content.content | b64decode | from_json }}"

    - name: Check if API key already configured
      ansible.builtin.set_fact:
        api_key_configured: "{{ pccs_config.ApiKey | default('') != '' }}"

    - name: Display current API key status
      ansible.builtin.debug:
        msg: "API key already configured: {{ api_key_configured }}"

    - name: Update API key in configuration
      ansible.builtin.replace:
        path: "{{ pccs_config_path }}"
        regexp: '"ApiKey"\s*:\s*"[^"]*"'
        replace: '"ApiKey": "{{ intel_api_key }}"'
      register: api_key_updated

    - name: Configure PCCS to listen on all interfaces (required for CVM access)
      ansible.builtin.replace:
        path: "{{ pccs_config_path }}"
        regexp: '"hosts"\s*:\s*"127\.0\.0\.1"'
        replace: '"hosts" : "0.0.0.0"'
      register: hosts_updated

    - name: Set config_updated fact
      ansible.builtin.set_fact:
        config_updated:
          changed: "{{ api_key_updated.changed or hosts_updated.changed }}"

    # Regenerate SSL certificate with SANs for CVM access
    # The default PCCS certificate only works for localhost
    # CVMs access PCCS via 10.0.2.2 (QEMU user-mode networking host IP)
    - name: Create OpenSSL config for PCCS certificate
      ansible.builtin.copy:
        content: |
          [req]
          distinguished_name = req_distinguished_name
          x509_extensions = v3_req
          prompt = no

          [req_distinguished_name]
          CN = localhost
          O = dstack
          C = US

          [v3_req]
          subjectAltName = @alt_names

          [alt_names]
          DNS.1 = localhost
          DNS.2 = pccs
          IP.1 = 127.0.0.1
          IP.2 = 10.0.2.2
          IP.3 = 0.0.0.0
        dest: /tmp/pccs_openssl.cnf
        mode: '0644'

    - name: Check current certificate expiration
      ansible.builtin.shell: |
        openssl x509 -in /opt/intel/sgx-dcap-pccs/ssl_key/file.crt -noout -enddate 2>/dev/null | cut -d= -f2
      register: cert_expiry
      changed_when: false
      failed_when: false

    - name: Check if certificate has 10.0.2.2 SAN
      ansible.builtin.shell: |
        openssl x509 -in /opt/intel/sgx-dcap-pccs/ssl_key/file.crt -noout -text 2>/dev/null | grep -q '10.0.2.2'
      register: cert_has_san
      changed_when: false
      failed_when: false

    - name: Regenerate PCCS SSL certificate
      ansible.builtin.command:
        cmd: >
          openssl req -x509 -nodes -days 3650 -newkey rsa:2048
          -keyout /opt/intel/sgx-dcap-pccs/ssl_key/private.pem
          -out /opt/intel/sgx-dcap-pccs/ssl_key/file.crt
          -config /tmp/pccs_openssl.cnf
      when: cert_has_san.rc != 0
      register: cert_regenerated

    - name: Set certificate ownership
      ansible.builtin.file:
        path: "{{ item }}"
        owner: pccs
        group: pccs
        mode: '0644'
      loop:
        - /opt/intel/sgx-dcap-pccs/ssl_key/private.pem
        - /opt/intel/sgx-dcap-pccs/ssl_key/file.crt
      when: cert_regenerated.changed | default(false)

    - name: Restart PCCS service
      ansible.builtin.systemd:
        name: pccs
        state: restarted
        daemon_reload: true
      when: config_updated.changed or not api_key_configured or cert_regenerated.changed | default(false)

    - name: Wait for PCCS to start
      ansible.builtin.wait_for:
        port: 8081
        host: 127.0.0.1
        timeout: 30

    - name: Wait additional time for PCCS to initialize
      ansible.builtin.pause:
        seconds: 5

    - name: Verify PCCS is responding
      ansible.builtin.uri:
        url: https://127.0.0.1:8081/sgx/certification/v4/rootcacrl
        return_content: false
        status_code: [200, 404]  # 404 is OK if no cached certs yet
        validate_certs: false  # PCCS uses self-signed cert
      register: pccs_health
      retries: 3
      delay: 5
      until: pccs_health.status in [200, 404]

    - name: Display configuration result
      ansible.builtin.debug:
        msg:
          - "============================================"
          - "PCCS Configuration Complete!"
          - "============================================"
          - ""
          - "API Key: Configured"
          - "Service: Running on port 8081"
          - "Health: Responding"

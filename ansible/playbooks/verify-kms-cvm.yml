---
# Ansible playbook to verify KMS CVM deployment
# Usage: ansible-playbook -i inventory/hosts.yml playbooks/verify-kms-cvm.yml
#
# This playbook verifies:
# - KMS CVM is running via VMM API
# - RPC port 9100 is accessible
# - Bootstrap completed successfully (keys generated)
# - TDX attestation quote is present
# - Public keys are available via API

- name: Verify KMS CVM Deployment
  hosts: dstack_servers
  become: false
  vars:
    kms_rpc_port: 9100
    vmm_api_url: "http://127.0.0.1:9080"

  tasks:
    # =========================================================================
    # CHECK CVM STATUS VIA VMM API
    # =========================================================================
    - name: Check VMM API is accessible
      ansible.builtin.uri:
        url: "{{ vmm_api_url }}/api/instances"
        method: GET
        return_content: yes
        status_code: [200, 401]
      register: vmm_api_check
      failed_when: false

    - name: Fail if VMM API not accessible
      ansible.builtin.fail:
        msg: |
          VMM API is not accessible at {{ vmm_api_url }}.

          Ensure dstack-vmm is running:
            sudo systemctl status dstack-vmm

          And configured with HTTP address:
            address = "127.0.0.1:9080"
      when: vmm_api_check.status is not defined or vmm_api_check.status not in [200, 401]

    - name: Get list of running CVMs
      ansible.builtin.uri:
        url: "{{ vmm_api_url }}/api/instances"
        method: GET
        return_content: yes
        status_code: [200]
      register: cvm_list
      failed_when: false

    - name: Check if KMS CVM exists
      ansible.builtin.set_fact:
        kms_cvm_exists: "{{ (cvm_list.json.vms | default([]) | selectattr('name', 'equalto', 'kms') | list | length) > 0 }}"
        kms_cvm_status: "{{ (cvm_list.json.vms | default([]) | selectattr('name', 'equalto', 'kms') | first | default({})).status | default('not_found') }}"
      when: cvm_list.status | default(0) == 200

    - name: Fail if KMS CVM not found
      ansible.builtin.fail:
        msg: |
          KMS CVM is not running.

          Deploy the KMS CVM:
            ansible-playbook playbooks/deploy-kms-cvm.yml -e "kms_domain=your.domain.com"
      when: not (kms_cvm_exists | default(false))

    # =========================================================================
    # CHECK RPC CONNECTIVITY
    # =========================================================================
    - name: Check RPC port is accessible
      ansible.builtin.wait_for:
        host: localhost
        port: "{{ kms_rpc_port }}"
        timeout: 10
        state: started
      register: port_status
      failed_when: false

    - name: Get KMS metadata via RPC
      ansible.builtin.uri:
        url: "http://localhost:{{ kms_rpc_port }}/prpc/KMS.GetMeta"
        method: GET
        return_content: yes
        status_code: [200]
      register: kms_meta
      failed_when: false

    # =========================================================================
    # PARSE AND VALIDATE RESPONSE
    # =========================================================================
    - name: Parse metadata
      ansible.builtin.set_fact:
        ca_pubkey: "{{ kms_meta.json.ca_pubkey | default('NOT AVAILABLE') }}"
        k256_pubkey: "{{ kms_meta.json.k256_pubkey | default('NOT AVAILABLE') }}"
        has_quote: "{{ (kms_meta.json.quote | default('')) | length > 100 }}"
        has_eventlog: "{{ (kms_meta.json.eventlog | default('')) | length > 10 }}"
        quote_length: "{{ (kms_meta.json.quote | default('')) | length }}"
      when: kms_meta.status | default(0) == 200

    - name: Validate public key formats
      ansible.builtin.set_fact:
        ca_key_valid: "{{ (ca_pubkey | default('')) | regex_search('^0x0[23]') is not none }}"
        k256_key_valid: "{{ (k256_pubkey | default('')) | regex_search('^0x0[23]') is not none }}"
      when: kms_meta.status | default(0) == 200

    # =========================================================================
    # DISPLAY VERIFICATION SUMMARY
    # =========================================================================
    - name: Display verification summary
      ansible.builtin.debug:
        msg:
          - "============================================"
          - "KMS CVM Verification"
          - "============================================"
          - ""
          - "VMM Status:"
          - "  VMM API: {{ 'Accessible' if vmm_api_check.status | default(0) in [200, 401] else 'Not Accessible' }}"
          - "  KMS CVM: {{ kms_cvm_status | default('unknown') }}"
          - ""
          - "KMS RPC Status:"
          - "  Port 9100: {{ 'Accessible' if port_status is success else 'Not Accessible' }}"
          - "  Metadata API: {{ 'Working' if kms_meta.status | default(0) == 200 else 'Not Available' }}"
          - ""
          - "TDX Attestation:"
          - "  Quote Present: {{ 'Yes (' + (quote_length | default('0') | string) + ' chars)' if has_quote | default(false) else 'No' }}"
          - "  Eventlog Present: {{ 'Yes' if has_eventlog | default(false) else 'No' }}"
          - ""
          - "Bootstrap Validation:"
          - "  CA Public Key: {{ 'Valid (compressed P256)' if ca_key_valid | default(false) else 'Invalid or missing' }}"
          - "  K256 Public Key: {{ 'Valid (compressed secp256k1)' if k256_key_valid | default(false) else 'Invalid or missing' }}"
          - ""
          - "Public Keys (truncated):"
          - "  CA: {{ (ca_pubkey | default('N/A'))[:50] }}..."
          - "  K256: {{ (k256_pubkey | default('N/A'))[:50] }}..."

    # =========================================================================
    # DETERMINE OVERALL STATUS
    # =========================================================================
    - name: Determine overall status
      ansible.builtin.set_fact:
        verification_passed: >-
          {{
            (kms_cvm_exists | default(false)) and
            (kms_cvm_status | default('') == 'running') and
            (port_status is success) and
            (kms_meta.status | default(0)) == 200 and
            (ca_key_valid | default(false)) and
            (k256_key_valid | default(false))
          }}

    - name: Fail if verification failed
      ansible.builtin.fail:
        msg: |
          KMS CVM verification FAILED.

          Issues found:
          {% if not (kms_cvm_exists | default(false)) %}- KMS CVM not found in VMM{% endif %}
          {% if kms_cvm_status | default('') != 'running' %}- KMS CVM not running (status: {{ kms_cvm_status | default('unknown') }}){% endif %}
          {% if port_status is failed %}- Port 9100 not accessible{% endif %}
          {% if (kms_meta.status | default(0)) != 200 %}- KMS Metadata API not responding{% endif %}
          {% if not (ca_key_valid | default(false)) %}- CA public key invalid or missing{% endif %}
          {% if not (k256_key_valid | default(false)) %}- K256 public key invalid or missing{% endif %}

          Try redeploying:
            ansible-playbook playbooks/deploy-kms-cvm.yml \
              -e "kms_domain=your.domain.com" -e "force_redeploy=true"
      when: not (verification_passed | bool)

    - name: Success message
      ansible.builtin.debug:
        msg:
          - ""
          - "============================================"
          - "KMS CVM Verification PASSED"
          - "============================================"
          - ""
          - "The KMS is running inside a CVM with:"
          - "  - Valid CA public key (P256)"
          - "  - Valid K256 signing key (secp256k1)"
          - "{% if has_quote | default(false) %}  - TDX attestation quote present{% else %}  - TDX quote not available (may be disabled or not in TDX mode){% endif %}"
          - ""
          - "The KMS is ready to serve TEE applications."
      when: verification_passed | bool

---
# Ansible playbook to verify KMS CVM deployment
# Usage: ansible-playbook -i inventory/hosts.yml playbooks/verify-kms-cvm.yml
#
# This playbook verifies:
# - KMS CVM is running via VMM API
# - RPC port 9100 is accessible
# - Bootstrap completed successfully (keys generated)
# - TDX attestation quote is present
# - Public keys are available via API

- name: Verify KMS CVM Deployment
  hosts: dstack_servers
  become: false
  vars:
    kms_rpc_port: 9100

  tasks:
    # =========================================================================
    # CHECK VMM SERVICE IS RUNNING
    # =========================================================================
    - name: Check VMM service is running
      ansible.builtin.systemd:
        name: dstack-vmm
      register: vmm_service
      failed_when: false

    - name: Fail if VMM service not running
      ansible.builtin.fail:
        msg: |
          dstack-vmm service is not running.

          Start the VMM:
            sudo systemctl start dstack-vmm

          Check status:
            sudo systemctl status dstack-vmm
      when: vmm_service.status.ActiveState | default('inactive') != 'active'

    - name: Check for running QEMU processes (KMS CVM)
      ansible.builtin.shell: |
        pgrep -f 'qemu-system.*kms' || pgrep -f 'qemu-system-x86_64' | head -1
      register: qemu_check
      failed_when: false
      changed_when: false

    - name: Set KMS CVM running fact
      ansible.builtin.set_fact:
        kms_cvm_exists: "{{ qemu_check.rc == 0 }}"
        kms_cvm_status: "{{ 'running' if qemu_check.rc == 0 else 'not_found' }}"

    - name: Fail if no CVM running
      ansible.builtin.fail:
        msg: |
          No KMS CVM appears to be running.

          Deploy the KMS CVM:
            ansible-playbook playbooks/deploy-kms-cvm.yml
      when: not kms_cvm_exists

    # =========================================================================
    # CHECK RPC CONNECTIVITY
    # =========================================================================
    - name: Check RPC port is accessible
      ansible.builtin.wait_for:
        host: localhost
        port: "{{ kms_rpc_port }}"
        timeout: 10
        state: started
      register: port_status
      failed_when: false

    - name: Get KMS metadata via RPC
      ansible.builtin.uri:
        url: "https://localhost:{{ kms_rpc_port }}/prpc/KMS.GetMeta"
        method: GET
        return_content: yes
        status_code: [200]
        validate_certs: false
      register: kms_meta
      failed_when: false

    # =========================================================================
    # PARSE AND VALIDATE RESPONSE
    # =========================================================================
    - name: Parse metadata
      ansible.builtin.set_fact:
        ca_pubkey: "{{ kms_meta.json.ca_pubkey | default('NOT AVAILABLE') }}"
        k256_pubkey: "{{ kms_meta.json.k256_pubkey | default('NOT AVAILABLE') }}"
        has_quote: "{{ (kms_meta.json.quote | default('')) | length > 100 }}"
        has_eventlog: "{{ (kms_meta.json.eventlog | default('')) | length > 10 }}"
        quote_length: "{{ (kms_meta.json.quote | default('')) | length }}"
      when: kms_meta.status | default(0) == 200

    - name: Validate public key formats
      ansible.builtin.set_fact:
        ca_key_valid: "{{ (ca_pubkey | default('')) | regex_search('^0x0[23]') is not none }}"
        k256_key_valid: "{{ (k256_pubkey | default('')) | regex_search('^0x0[23]') is not none }}"
      when: kms_meta.status | default(0) == 200

    # =========================================================================
    # DISPLAY VERIFICATION SUMMARY
    # =========================================================================
    - name: Display verification summary
      ansible.builtin.debug:
        msg:
          - "============================================"
          - "KMS CVM Verification"
          - "============================================"
          - ""
          - "VMM Status:"
          - "  VMM Service: {{ vmm_service.status.ActiveState | default('unknown') }}"
          - "  KMS CVM: {{ kms_cvm_status | default('unknown') }}"
          - ""
          - "KMS RPC Status:"
          - "  Port 9100: {{ 'Accessible' if port_status is success else 'Not Accessible' }}"
          - "  Metadata API: {{ 'Working' if kms_meta.status | default(0) == 200 else 'Not Available' }}"
          - ""
          - "TDX Attestation:"
          - "  Quote Present: {{ 'Yes (' + (quote_length | default('0') | string) + ' chars)' if has_quote | default(false) else 'No' }}"
          - "  Eventlog Present: {{ 'Yes' if has_eventlog | default(false) else 'No' }}"
          - ""
          - "Bootstrap Validation:"
          - "  CA Public Key: {{ 'Valid (compressed P256)' if ca_key_valid | default(false) else 'Invalid or missing' }}"
          - "  K256 Public Key: {{ 'Valid (compressed secp256k1)' if k256_key_valid | default(false) else 'Invalid or missing' }}"
          - ""
          - "Public Keys (truncated):"
          - "  CA: {{ (ca_pubkey | default('N/A'))[:50] }}..."
          - "  K256: {{ (k256_pubkey | default('N/A'))[:50] }}..."

    # =========================================================================
    # DETERMINE OVERALL STATUS
    # =========================================================================
    - name: Determine overall status
      ansible.builtin.set_fact:
        verification_passed: >-
          {{
            (vmm_service.status.ActiveState | default('') == 'active') and
            (kms_cvm_exists | default(false)) and
            (kms_cvm_status | default('') == 'running') and
            (port_status is success) and
            (kms_meta.status | default(0)) == 200 and
            (k256_key_valid | default(false))
          }}

    - name: Fail if verification failed
      ansible.builtin.fail:
        msg: |
          KMS CVM verification FAILED.

          Issues found:
          {% if vmm_service.status.ActiveState | default('') != 'active' %}- VMM service not running{% endif %}
          {% if not (kms_cvm_exists | default(false)) %}- KMS CVM not found{% endif %}
          {% if kms_cvm_status | default('') != 'running' %}- KMS CVM not running (status: {{ kms_cvm_status | default('unknown') }}){% endif %}
          {% if port_status is failed %}- Port 9100 not accessible{% endif %}
          {% if (kms_meta.status | default(0)) != 200 %}- KMS Metadata API not responding{% endif %}
          {% if not (k256_key_valid | default(false)) %}- K256 public key invalid or missing{% endif %}

          Try redeploying:
            ansible-playbook playbooks/deploy-kms-cvm.yml -e "force_redeploy=true"
      when: not (verification_passed | bool)

    - name: Success message
      ansible.builtin.debug:
        msg:
          - ""
          - "============================================"
          - "KMS CVM Verification PASSED"
          - "============================================"
          - ""
          - "The KMS is running inside a CVM with:"
          - "  - Valid CA public key (P256)"
          - "  - Valid K256 signing key (secp256k1)"
          - "{% if has_quote | default(false) %}  - TDX attestation quote present{% else %}  - TDX quote not available (may be disabled or not in TDX mode){% endif %}"
          - ""
          - "The KMS is ready to serve TEE applications."
      when: verification_passed | bool

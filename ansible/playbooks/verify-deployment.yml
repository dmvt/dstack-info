---
# verify-deployment.yml
# Phase 5: Comprehensive verification of first application deployment
#
# Prerequisites:
#   - All Phase 5 steps completed
#
# Usage:
#   ansible-playbook -i inventory/hosts.yml playbooks/verify-deployment.yml

- name: Verify First Application Deployment
  hosts: dstack_servers
  become: yes
  vars:
    images_dir: /var/lib/dstack/images
    vmm_http_port: 9080

  tasks:
    - name: "=== Phase 5.1: Guest Image Verification ==="
      ansible.builtin.debug:
        msg: "Checking guest OS images..."

    - name: Check images directory exists
      ansible.builtin.stat:
        path: "{{ images_dir }}"
      register: images_dir_stat

    - name: Verify images directory
      ansible.builtin.assert:
        that: images_dir_stat.stat.exists
        fail_msg: "Images directory not found. Run setup-guest-images.yml"
        success_msg: "✓ Images directory exists"

    - name: Find installed images
      ansible.builtin.find:
        paths: "{{ images_dir }}"
        file_type: directory
        patterns: "dstack-*"
      register: installed_images

    - name: Verify at least one image installed
      ansible.builtin.assert:
        that: installed_images.files | length > 0
        fail_msg: "No guest OS images found"
        success_msg: "✓ {{ installed_images.files | length }} image(s) installed"

    - name: Check image components
      ansible.builtin.stat:
        path: "{{ item.path }}/metadata.json"
      loop: "{{ installed_images.files }}"
      register: image_metadata

    - name: Display installed images
      ansible.builtin.debug:
        msg: "  - {{ item.path | basename }}"
      loop: "{{ installed_images.files }}"
      loop_control:
        label: "{{ item.path | basename }}"

    - name: Check VMM service status
      ansible.builtin.command:
        cmd: systemctl is-active dstack-vmm
      register: vmm_active
      changed_when: false
      failed_when: false

    - name: Verify VMM service running
      ansible.builtin.assert:
        that: vmm_active.stdout == 'active'
        fail_msg: "VMM service not running. Run: sudo systemctl start dstack-vmm"
        success_msg: "✓ VMM service running"

    - name: Test VMM HTTP API
      ansible.builtin.uri:
        url: "http://127.0.0.1:{{ vmm_http_port }}/api/images"
        method: GET
        return_content: yes
      register: vmm_api
      failed_when: false

    - name: Verify VMM API responding
      ansible.builtin.assert:
        that: vmm_api.status == 200
        fail_msg: "VMM HTTP API not responding"
        success_msg: "✓ VMM HTTP API responding"

    - name: Verify VMM sees installed images
      ansible.builtin.set_fact:
        vmm_image_count: "{{ vmm_api.json.images | default([]) | length }}"
      when: vmm_api.status == 200

    - name: Display VMM visible images
      ansible.builtin.debug:
        msg: "VMM found {{ vmm_image_count }} image(s): {{ vmm_api.json.images | map(attribute='name') | list }}"
      when: vmm_api.status == 200

    - name: "=== Phase 5.2: Application Deployment Verification ==="
      ansible.builtin.debug:
        msg: "Checking deployed applications..."

    - name: Check for running QEMU instances
      ansible.builtin.shell: |
        pgrep -af 'qemu-system-x86_64' | grep -v grep || true
      register: qemu_processes
      changed_when: false

    - name: Count running instances
      ansible.builtin.set_fact:
        running_instance_count: "{{ qemu_processes.stdout_lines | length }}"

    - name: Display instance count
      ansible.builtin.debug:
        msg: "Running CVM instances: {{ running_instance_count }}"

    - name: Display running QEMU processes
      ansible.builtin.debug:
        msg: "{{ qemu_processes.stdout }}"
      when: running_instance_count | int > 0

    - name: Check hello-world instance exists
      ansible.builtin.shell: |
        pgrep -f 'qemu.*hello-world' || true
      register: hello_world_check
      changed_when: false

    - name: Set hello-world exists fact
      ansible.builtin.set_fact:
        hello_world_exists: "{{ hello_world_check.stdout | length > 0 }}"

    - name: Test hello-world accessibility
      ansible.builtin.uri:
        url: "http://127.0.0.1:10080/"
        method: GET
        return_content: yes
      register: hello_world_response
      when: hello_world_exists | default(false)
      failed_when: false
      retries: 3
      delay: 5

    - name: Verify hello-world content
      ansible.builtin.assert:
        that: "'dstack' in hello_world_response.content"
        fail_msg: "Hello World application content verification failed"
        success_msg: "✓ Hello World application responding correctly"
      when: hello_world_exists | default(false) and hello_world_response.status | default(0) == 200

    - name: "=== Phase 5.3: Attestation Verification ==="
      ansible.builtin.debug:
        msg: "Checking attestation capability via KMS..."

    - name: Get KMS metadata (includes attestation info)
      ansible.builtin.uri:
        url: "https://localhost:9100/prpc/KMS.GetMeta"
        method: GET
        return_content: yes
        validate_certs: false
        timeout: 30
      register: kms_meta
      failed_when: false

    - name: Check KMS attestation status
      ansible.builtin.set_fact:
        kms_available: "{{ kms_meta.status | default(0) == 200 }}"
        has_quote: "{{ (kms_meta.json.quote | default('')) | length > 100 }}"
        has_k256_key: "{{ (kms_meta.json.k256_pubkey | default('')) | length > 10 }}"
      when: kms_meta.status | default(0) == 200

    - name: Display KMS attestation info
      ansible.builtin.debug:
        msg:
          - "KMS Status: {{ 'Available' if kms_available | default(false) else 'Not Available' }}"
          - "TDX Quote: {{ 'Present' if has_quote | default(false) else 'Not Available' }}"
          - "K256 Key: {{ kms_meta.json.k256_pubkey[:50] | default('N/A') }}..."
      when: kms_available | default(false)

    - name: Note about direct instance quote
      ansible.builtin.debug:
        msg:
          - "NOTE: Direct quote retrieval from instances via VMM API"
          - "is not available via TCP connections (security restriction)."
          - "Use KMS attestation or access tappd inside the CVM directly."
      when: not (kms_available | default(false))

    - name: "=== Verification Summary ==="
      ansible.builtin.debug:
        msg:
          - "========================================="
          - "Phase 5 Deployment Verification Complete!"
          - "========================================="
          - ""
          - "Phase 5.1 - Guest Images:"
          - "  - Images directory: {{ '✓' if images_dir_stat.stat.exists else '✗' }}"
          - "  - Images installed: {{ installed_images.files | length }}"
          - "  - VMM service: {{ '✓' if vmm_active.stdout == 'active' else '✗' }}"
          - "  - VMM API: {{ '✓' if vmm_api.status == 200 else '✗' }}"
          - "  - VMM images: {{ vmm_image_count | default(0) }}"
          - ""
          - "Phase 5.2 - Application Deployment:"
          - "  - Running CVM instances: {{ running_instance_count | default(0) }}"
          - "  - Hello World: {{ '✓' if hello_world_exists | default(false) else '✗ Not deployed' }}"
          - "  - Hello World accessible: {{ '✓' if (hello_world_response.status | default(0)) == 200 else '✗' }}"
          - ""
          - "Phase 5.3 - Attestation:"
          - "  - KMS available: {{ '✓' if kms_available | default(false) else '✗' }}"
          - "  - TDX quote present: {{ '✓' if has_quote | default(false) else '⚠ Not available' }}"
          - "  - K256 key valid: {{ '✓' if has_k256_key | default(false) else '⚠ Not verified' }}"
          - ""
          - "Overall Status: {{ 'All checks passed!' if vmm_active.stdout == 'active' and vmm_api.status == 200 else 'Some checks failed' }}"
          - "========================================="

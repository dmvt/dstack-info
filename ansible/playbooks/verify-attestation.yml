---
# verify-attestation.yml
# Phase 5.3: Verify TDX attestation for running CVMs
#
# Prerequisites:
#   - Application deployed (Phase 5.2)
#   - CVM instance running
#
# Variables (set in group_vars/all.yml or via -e):
#   - instance_name: Name of instance to verify (default: hello-world)
#
# Usage:
#   ansible-playbook -i inventory/hosts.yml playbooks/verify-attestation.yml
#   ansible-playbook -i inventory/hosts.yml playbooks/verify-attestation.yml -e "instance_name=my-app"

- name: Verify TDX Attestation
  hosts: dstack_servers
  become: yes
  vars:
    vmm_http_port: 9080
    instance_name: "hello-world"
    report_data: "616e7369626c652d766572696669636174696f6e"  # hex: "ansible-verification"

  tasks:
    - name: "=== TDX Attestation Verification ==="
      ansible.builtin.debug:
        msg: "Verifying attestation for instance: {{ instance_name }}"

    - name: Check VMM service is running
      ansible.builtin.systemd:
        name: dstack-vmm
      register: vmm_service
      failed_when: false

    - name: Fail if VMM not running
      ansible.builtin.fail:
        msg: "VMM service not running"
      when: vmm_service.status.ActiveState | default('inactive') != 'active'

    - name: Check for running CVM
      ansible.builtin.shell: |
        pgrep -f 'qemu.*{{ instance_name }}' || pgrep -f 'qemu-system-x86_64' | head -1
      register: qemu_check
      changed_when: false
      failed_when: false

    - name: Set instance exists fact
      ansible.builtin.set_fact:
        instance_exists: "{{ qemu_check.rc == 0 }}"
        instance_status: "{{ 'running' if qemu_check.rc == 0 else 'not_found' }}"

    - name: Fail if instance not found
      ansible.builtin.fail:
        msg: "No CVM instance found. Deploy it first."
      when: not instance_exists

    - name: Set instance info
      ansible.builtin.set_fact:
        instance_info:
          status: "{{ instance_status }}"
          image: "dstack-{{ dstack_version | default('0.5.5') }}"

    - name: Display instance information
      ansible.builtin.debug:
        msg:
          - "Instance: {{ instance_name }}"
          - "Status: {{ instance_info.status }}"
          - "Image: {{ instance_info.image }}"

    - name: "=== Requesting TDX Quote via KMS ==="
      ansible.builtin.debug:
        msg: "Fetching attestation info from KMS (port 9100)..."

    - name: Get KMS metadata with attestation info
      ansible.builtin.uri:
        url: "https://localhost:9100/prpc/KMS.GetMeta"
        method: GET
        return_content: yes
        validate_certs: false
        timeout: 30
      register: kms_meta
      failed_when: false

    - name: Check if KMS responded
      ansible.builtin.set_fact:
        kms_available: "{{ kms_meta.status | default(0) == 200 }}"

    - name: Display KMS attestation info
      ansible.builtin.debug:
        msg:
          - "KMS K256 Public Key: {{ kms_meta.json.k256_pubkey | default('N/A') }}"
          - "KMS Contract: {{ kms_meta.json.kms_contract_address | default('N/A') }}"
          - "Chain ID: {{ kms_meta.json.chain_id | default('N/A') }}"
      when: kms_available

    - name: Note about direct quote API
      ansible.builtin.debug:
        msg:
          - "NOTE: Direct quote retrieval via VMM /api/instances/{name}/quote"
          - "is not available via TCP connections due to security restrictions."
          - "Use the tappd endpoint inside the CVM or KMS attestation instead."
      when: not kms_available

    - name: "=== Attestation Verification Summary ==="
      ansible.builtin.debug:
        msg:
          - "========================================="
          - "TDX Attestation Verification Results"
          - "========================================="
          - ""
          - "Instance: {{ instance_name }}"
          - "Status: {{ instance_info.status }}"
          - "Image: {{ instance_info.image }}"
          - ""
          - "KMS Status: {{ 'Available' if kms_available else 'Not Available' }}"
          - "{% if kms_available %}"
          - "K256 Public Key: {{ kms_meta.json.k256_pubkey[:20] }}..."
          - "Contract: {{ kms_meta.json.kms_contract_address }}"
          - "{% endif %}"
          - ""
          - "NOTE: Direct quote retrieval requires accessing tappd"
          - "inside the CVM. For KMS attestation, the KMS itself"
          - "performs attestation during bootstrap and registers"
          - "its public key on-chain."
          - "========================================="

    - name: Save attestation report
      ansible.builtin.copy:
        content: |
          # TDX Attestation Report
          # Generated: {{ ansible_date_time.iso8601 }}
          # Instance: {{ instance_name }}

          ## Instance Information
          - Name: {{ instance_name }}
          - Status: {{ instance_info.status }}
          - Image: {{ instance_info.image }}

          ## KMS Attestation (if available)
          {% if kms_available %}
          - K256 Public Key: {{ kms_meta.json.k256_pubkey }}
          - Contract Address: {{ kms_meta.json.kms_contract_address }}
          - Chain ID: {{ kms_meta.json.chain_id }}
          {% else %}
          - KMS not available on port 9100
          {% endif %}

          ## Notes
          Direct quote retrieval via VMM API is restricted to Unix socket connections.
          For attestation verification, use the KMS on-chain registration or
          access tappd inside the CVM directly.
        dest: "/tmp/attestation-report-{{ instance_name }}.md"

    - name: Report file location
      ansible.builtin.debug:
        msg: "Attestation report saved to: /tmp/attestation-report-{{ instance_name }}.md"

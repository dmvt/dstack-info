---
# deploy-hello-world.yml
# Deploy Hello World application to a CVM via VMM
#
# Prerequisites:
#   - VMM service running with web interface
#   - Guest images configured
#
# Variables (set in group_vars/all.yml or via -e):
#   - app_name: Application name (default: hello-world)
#   - dstack_version: Image version (default: 0.4.0)
#   - app_vcpus: Number of vCPUs (default: 2)
#   - app_memory: Memory in MB (default: 2048)
#
# Usage:
#   ansible-playbook -i inventory/hosts.yml playbooks/deploy-hello-world.yml

- name: Deploy Hello World Application
  hosts: dstack_servers
  become: yes
  vars:
    vmm_http_port: 9080
    app_name: "hello-world"
    dstack_version: "0.4.0"
    app_vcpus: 2
    app_memory: 2048
    app_dir: "/root/dstack-apps/{{ app_name }}"

  tasks:
    # =========================================================================
    # VERIFY VMM IS RUNNING
    # =========================================================================
    - name: Check VMM service is running
      ansible.builtin.systemd:
        name: dstack-vmm
      register: vmm_service
      failed_when: false

    - name: Fail if VMM not running
      ansible.builtin.fail:
        msg: |
          VMM service not running.

          Start VMM first:
            sudo systemctl start dstack-vmm
      when: vmm_service.status.ActiveState | default('inactive') != 'active'

    # =========================================================================
    # CREATE APPLICATION FILES
    # =========================================================================
    - name: Create application directory
      ansible.builtin.file:
        path: "{{ app_dir }}"
        state: directory
        mode: '0755'
        owner: root
        group: root

    - name: Create HTML content directory
      ansible.builtin.file:
        path: "{{ app_dir }}/html"
        state: directory
        mode: '0755'
        owner: root
        group: root

    - name: Create Docker Compose file
      ansible.builtin.copy:
        content: |
          version: '3'
          services:
            nginx:
              image: nginx:alpine
              ports:
                - "80:80"
              volumes:
                - ./html:/usr/share/nginx/html:ro
                - /var/run/tappd.sock:/var/run/tappd.sock
              restart: always
              environment:
                - NGINX_HOST=localhost
                - NGINX_PORT=80
        dest: "{{ app_dir }}/docker-compose.yaml"
        mode: '0644'
        owner: root
        group: root

    - name: Create HTML index page
      ansible.builtin.copy:
        content: |
          <!DOCTYPE html>
          <html>
          <head>
              <title>dstack Hello World</title>
              <style>
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                      max-width: 800px;
                      margin: 50px auto;
                      padding: 20px;
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      min-height: 100vh;
                  }
                  .container {
                      background: white;
                      border-radius: 10px;
                      padding: 40px;
                      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
                  }
                  h1 { color: #333; margin-bottom: 20px; }
                  .success {
                      background: #d4edda;
                      border: 1px solid #c3e6cb;
                      color: #155724;
                      padding: 15px;
                      border-radius: 5px;
                      margin: 20px 0;
                  }
                  .info {
                      background: #e7f3ff;
                      border: 1px solid #b6d4fe;
                      color: #084298;
                      padding: 15px;
                      border-radius: 5px;
                      margin: 20px 0;
                  }
                  code {
                      background: #f4f4f4;
                      padding: 2px 6px;
                      border-radius: 3px;
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>Hello from dstack CVM!</h1>
                  <div class="success">
                      <strong>Success!</strong> Your application is running inside a
                      TDX-protected Confidential Virtual Machine.
                  </div>
                  <div class="info">
                      <strong>Deployed by Ansible</strong>
                      <ul>
                          <li>Your code is running in encrypted memory</li>
                          <li>The host cannot inspect your application's data</li>
                          <li>Hardware attestation proves this environment is genuine</li>
                      </ul>
                  </div>
                  <h2>Environment Details</h2>
                  <ul>
                      <li>Intel TDX hardware protection</li>
                      <li>Measured boot chain (MRTD, RTMR0-3)</li>
                      <li>Encrypted memory isolation</li>
                      <li>Remote attestation capability</li>
                  </ul>
              </div>
          </body>
          </html>
        dest: "{{ app_dir }}/html/index.html"
        mode: '0644'
        owner: root
        group: root

    # =========================================================================
    # DEPLOY APPLICATION
    # =========================================================================
    - name: Check if application already deployed
      ansible.builtin.shell: |
        pgrep -f 'qemu.*{{ app_name }}' || true
      register: existing_app
      changed_when: false

    - name: Set existing instance fact
      ansible.builtin.set_fact:
        app_exists: "{{ existing_app.stdout | length > 0 }}"

    - name: Stop existing application if present
      ansible.builtin.uri:
        url: "http://127.0.0.1:{{ vmm_http_port }}/prpc/StopVm?json"
        method: POST
        body_format: json
        body:
          name: "{{ app_name }}"
        status_code: [200, 400, 404]
      when: app_exists
      failed_when: false

    - name: Delete existing application if present
      ansible.builtin.uri:
        url: "http://127.0.0.1:{{ vmm_http_port }}/prpc/RemoveVm?json"
        method: POST
        body_format: json
        body:
          name: "{{ app_name }}"
        status_code: [200, 400, 404]
      when: app_exists
      failed_when: false

    - name: Wait for cleanup
      ansible.builtin.pause:
        seconds: 5
      when: app_exists

    - name: Read docker-compose file
      ansible.builtin.slurp:
        src: "{{ app_dir }}/docker-compose.yaml"
      register: compose_content

    - name: Build app manifest
      ansible.builtin.set_fact:
        app_manifest:
          docker_compose_file: "{{ compose_content.content | b64decode }}"
          docker_config:
            url: ""
            username: ""
            password: ""
          features:
            kms: false
            local_key_provider: false
            tproxy: false
            host_net: false
          tcb_info:
            allow_debug: false
            allow_outdated: false
          encrypted_env: ""
          allowed_envs: []

    - name: Deploy application via VMM API
      ansible.builtin.uri:
        url: "http://127.0.0.1:{{ vmm_http_port }}/prpc/CreateVm?json"
        method: POST
        body_format: json
        body:
          name: "{{ app_name }}"
          image: "dstack-{{ dstack_version }}"
          compose_file: "{{ app_manifest | to_json }}"
          vcpu: "{{ app_vcpus }}"
          memory: "{{ app_memory }}"
          disk_size: 10
          ports:
            - host_port: 10080
              vm_port: 80
              protocol: "tcp"
        return_content: yes
        status_code: [200, 201]
      register: deploy_result
      retries: 3
      delay: 5

    - name: Display deployment result
      ansible.builtin.debug:
        msg: "Deployment result: {{ deploy_result.json }}"
      when: deploy_result.json is defined

    # =========================================================================
    # VERIFY DEPLOYMENT
    # =========================================================================
    - name: Wait for CVM to boot
      ansible.builtin.pause:
        seconds: 30

    - name: Wait for application port to be available
      ansible.builtin.wait_for:
        host: 127.0.0.1
        port: 10080
        timeout: 120
        state: started
      register: port_check

    - name: Check QEMU process is running
      ansible.builtin.shell: |
        pgrep -f 'qemu.*{{ app_name }}' || pgrep -f 'qemu-system-x86_64' | head -1
      register: qemu_check
      changed_when: false

    - name: Set instance status
      ansible.builtin.set_fact:
        instance_status: "{{ 'running' if qemu_check.rc == 0 else 'not_found' }}"
        app_port: 10080

    - name: Display instance information
      ansible.builtin.debug:
        msg:
          - "Instance: {{ app_name }}"
          - "Status: {{ instance_status }}"
          - "Image: dstack-{{ dstack_version }}"
          - "vCPUs: {{ app_vcpus }}"
          - "Memory: {{ app_memory }} MB"
          - "Port: {{ app_port }}"

    - name: Test application accessibility
      ansible.builtin.uri:
        url: "http://127.0.0.1:{{ app_port }}/"
        method: GET
        return_content: yes
      register: app_response
      retries: 10
      delay: 5
      until: app_response.status == 200
      failed_when: false

    - name: Verify application content
      ansible.builtin.assert:
        that:
          - "'dstack' in app_response.content"
        fail_msg: "Application content verification failed"
        success_msg: "Application content verified successfully"
      when: app_response.status | default(0) == 200

    # =========================================================================
    # SUMMARY
    # =========================================================================
    - name: Summary
      ansible.builtin.debug:
        msg:
          - "========================================"
          - "Hello World Deployment Complete!"
          - "========================================"
          - ""
          - "Application: {{ app_name }}"
          - "Status: {{ instance_status }}"
          - "Image: dstack-{{ dstack_version }}"
          - "Resources: {{ app_vcpus }} vCPUs, {{ app_memory }} MB RAM"
          - ""
          - "Access URL: http://127.0.0.1:{{ app_port }}/"
          - "Accessibility: {{ 'OK' if app_response.status | default(0) == 200 else 'FAILED' }}"
          - ""
          - "VMM Web Interface: http://localhost:{{ vmm_http_port }}"
